{% extends "base.html" %}

{% block name %}Coupons{% endblock %}

{% block css %}
{% endblock %}

{% block content %}
<!-- <1!-- Coupons/Variants/Collections View Block --1> -->
<!-- <div class="col-sm-12"> -->
<!--   <div class="block" style="padding-bottom:0px"> -->
<!--     <1!-- Coupons/Variants/Collections Switch Block --1> -->
<!--     <div class="block-title"> -->
<!--       <ul class="nav nav-tabs" data-toggle="tabs"> -->
<!--         <li class="active"><a href="">Coupons</a></li> -->
<!--         <1!-- <li class=""><a href="">Variants</a></li> --1> -->
<!--         <1!-- <li class=""><a href="">Collections</a></li> --1> -->
<!--       </ul> -->
<!--     </div> -->
<!--     <1!-- END Coupons/Variants/Collections Switch Block --1> -->
<!--   </div> -->
<!-- </div> -->
<!-- <1!-- END Coupons/Variants/Collections View Block --1> -->

<!-- Coupons View Block -->
<div class="col-sm-12">
  <!-- Empty Coupons Block -->
  <div id="empty-table" class="row text-center text-dark-op" style="display:none;margin-top:50px;margin-bottom:50px">
    <div class="col-xs-10 col-xs-offset-1">
      <i class="gi gi-book" style="font-size:100px;"></i>
      <h2>It doesn't seem that anyone's added coupons to <strong>{{ ctx.organization.Name }}</strong> yet. Just complete the form below to add one.
    </div>
  </div>
  <!-- END Empty Coupons Block -->
  <div class="block full">
    <!-- Coupons View Title -->
    <div class="block-title">
      <h2>Coupons</h2>
    </div>
    <!-- END Coupons View Title -->

    <!-- Coupons View Content -->
    <div id="display" class="form-group form-inline">
    </div>
    <table id="table" class="table table-striped table-bordered table-vcenter">
    </table>
    <div id="pagination" class="row text-center">
      <a href="#" class="btn btn-primary previous" data-action="previous"><strong>&lsaquo;</strong></a>
      <input class="text-center form-control" type="text" readonly="readonly" data-max-page="40" style="width:125px;display:inline;padding-top:5px"/>
      <a href="#" class="btn btn-primary next" data-action="next"><strong>&rsaquo;</strong></a>
    </div>
    <!-- <div class="row text-center"> -->
    <!--     <i class="fa fa-circle-o-notch fa-3x fa-spin text-primary"></i> -->
    <!-- </div> -->
  </div>
</div>
<!-- END Coupons View Block -->

<!-- New Coupons View Block -->
<div class="col-sm-12">
  <div class="block">
    <div class="block-title">
      <h2>New Coupon</h2>
    </div>
    <form id="form-new-coupon" method="post" class="form-horizontal">
      <div class="row">
        <div class="col-md-6">
          <h4>What type of coupon is this?</h4>
          <div id="coupon-info" class="block" style="min-height:205px">
          </div>
        </div>
        <div class="col-md-6">
          <h4>What is the discount amount or percent? (Price or percent)</h4>
          <div class="row">
            <div id="coupon-amount" class="block">
            </div>
          </div>
          <h4>What product does it apply to?</h4>
          <div class="row">
            <div id="coupon-product-id" class="block">
            </div>
          </div>
        </div>
      </div>
      <div class="form-group form-actions text-center">
        <button type="submit" class="btn btn-effect-ripple btn-primary"><i class="fa fa-plus"></i> Add</button>
      </div>
    </form>
    <!-- END Coupons View Content -->
  </div>
</div>
<!-- END New Coupons View Block -->
{% endblock %}

{% block js %}
<script src="{{ staticUrl }}/js/util.js"></script>
<script src="{{ staticUrl }}/js/jquery.jqpagination.js"></script>
<script src="{{ staticUrl }}/js/jquery.serialize-object.min.js"></script>
<script src="{{ staticUrl }}/js/form-builder.js"></script>
<script src="{{ staticUrl }}/js/table-builder.js"></script>
<script src="{{ staticUrl }}/js/rest-forms.js"></script>
<script>
  $(function(){
    BuildTable($('#table'), {
      columns: [
        {
          field: 'id',
          name: 'ID',
          css: {
            width: '50px',
          },
          render: 'id',
        },
        {
          field: 'name',
          name: 'Name',
        },
        {
          field: 'code',
          name: 'Code',
          render: 'raw',
        },
        {
          field: 'type',
          name: 'Type',
          render: 'text',
        },
        {
          field: 'amount',
          name: 'Amount',
          render: function(val, data, $el) {
              $el.addClass('text-right')
              if (data.type === 'flat') {
                  return Util.renderUICurrencyFromJSON(val);
              } else if(data.type === 'percent') {
                  return val + '%';
              } else {
                  return 'N/A'
              }
          },
        },
        {
          field: 'enabled',
          name: 'Enabled',
          render: 'text',
        },
        {
          field: 'createdAt',
          name: 'Created At',
          render: 'date',
        },
        {
          field: 'updatedAt',
          name: 'Last Updated',
          render: 'ago',
        }
      ],
      itemUrl: '{{ urlFor("platform", "/coupon") }}',
      apiUrl: '{{ urlFor("api", "/coupon") }}',
      apiToken: '{{ ctx.organization.MustGetTokenByName("live-secret-key") }}',
      startPage: 1,
      startDisplay: 5,
      displayOptions: [5, 10, 20],
      $display: $('#display'),
      $pagination: $('#pagination'),
      $empty: $('#empty-table'),
      canDelete: true,
      checkboxes: false,
    });

    BuildForm($('#form-new-coupon'),[
        // coupon info
        {
          id: 'name',
          name: 'name',
          label: 'Name',
          type: 'text',
          asterisk: false,
          rules: [
            {
              rule: 'required',
              value: true,
              message: 'Enter a name for your coupon'
            }
          ],
          $parent: $('#coupon-info')
        },
        {
          id: 'code',
          name: 'code',
          label: 'Code',
          type: 'text',
          asterisk: false,
          rules: [
            {
              rule: 'required',
              value: true,
              message: 'Enter a unique code for your coupon'
            }
          ],
          $parent: $('#coupon-info')
        },
        {
          id: 'type',
          name: 'type',
          label: 'Type',
          type: 'select',
          asterisk: false,
          value: [
            {
              name: 'Flat (In product\'s currency)',
              id: 'flat',
            },
            {
              name: 'Percent',
              id: 'percent',
            },
            {
              name: 'Free shipping',
              id: 'free-shipping',
            },
          ],
          rules: [
            {
              rule: 'required',
              value: true,
              message: 'Enter a type for your coupon'
            }
          ],
          $parent: $('#coupon-info')
        },
        // coupon amount
        {
          id: 'amount',
          name: 'amount',
          label: 'Amount',
          type: 'currency',
          value: '0',
          asterisk: false,
          rules: [
            {
              rule: 'required',
              value: true,
              message: 'Enter an an amount to discount'
            },
          ],
          $parent: $('#coupon-amount')
        },
        {
          id: 'productId',
          name: 'productId',
          label: 'Product',
          value: [
              {
                  selected: true,
                  name: 'All',
                  id: ''
              },
              {% for product in products %}
              {
                  name: '{{ product.Name }} ({{ product.Slug }})',
                  id: '{{ product.Id_ }}'
              },
              {% endfor %}
          ],
          type: 'select',
          $parent: $('#coupon-product-id'),
        },
    ]);

  (function() {
      $('#type').chosen().on('change', function(){
          if ($(this).val() === 'free-shipping') {
            $('#amount').prop('disabled', true).val(0);
          } else {
            $('#amount').prop('disabled', false);
          }
      })

  })();
});

var api = NewRestAPI(
    '{{ urlFor("api", "/coupon") }}',
    '{{ ctx.organization.MustGetTokenByName("live-secret-key") }}',
    $('#form-new-coupon'),
    {
        amount: function(val) {
            var type = $('#type').val();
            if (type === 'flat') {
                // To cents
                return Util.renderJSONCurrencyFromUI(val);
            } else if (type === 'percent') {
                return parseFloat(val);
            } else {
                return 0
            }
        },
    }
  );
$('#form-new-coupon').on('submit', function(e){
    var $form = $(this);
    requestAnimationFrame(function() {
        if ($('.form-group.has-error').length === 0) {
            api.post(function(data) {
                window.location.replace('{{ urlFor("platform", "/coupons") }}')
            }, $form)
        }
    })
    e.preventDefault();
    return false;
})
</script>
{% endblock %}
{% block menulink %}menu-coupons{% endblock %}
