<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="/css/reset.css">
    <link rel="stylesheet" type="text/css" href="/css/preorder.css">
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Michroma:400,400italic,700normal,700italic|PT+Serif:400,400italic,700normal,700italic"/>
    <script type="text/javascript" src="/js/jquery.min.js"></script>
    <script type="text/javascript" src="/js/card.js"></script>
    <script type="text/javascript" src="/js/validate.min.js"></script>
    <script src="//use.typekit.net/uye2ojv.js"></script>
    <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
    <script>
      var PreorderData = {
        user: {{ userJSON | safe }},
          contributions: {{ contributionsJSON | safe }},
      };
    </script>
  </head>
  <body>

    <div class="wide center body">
      <div class="content-centered logo">
        <h1>Skully</h1>
      </div>
      <div class="instructions">
        <p>Please enter your shipping and size information below to claim your pre-orders of the AR-1 and apparel package from our Indiegogo campaign.</p>
      </div>
      <form id="skully" name="skully" action="preorder" method="post">
        <div class="narrow center shipping">
          <div class="form">
            <input id="email" name="User.Email" class="email" type="text" value="Email Address ex. info@skullysystems.com">
            <input id="password" name="Password" class="password" type="text" value="Password, minimum 6 character">
            <input id="password_confirm" name="PasswordConfirm" class="password" type="text" value="Type in your password again">
            <input id="first_name" name="User.FirstName" class="first_name" type="text" value="First Name ex. SKULLY">
            <input id="last_name" name="User.LastName" class="last_name" type="text" value="Last Name ex. Systems">
            <input id="phone" name="User.Phone" class="phone" type="text" value="Phone Number ex. 5-555-555-5555">
            <input id="address1" name="ShippingAddress.Line1" class="address1" type="text" value="Address ex. 555 3rd Street">
            <input id="address2" name="ShippingAddress.Line2" class="address2 optional" type="text" value="Address 2 ex. Suite 3, Apt#">
            <input id="city" name="ShippingAddress.City" class="city" type="text" value="City ex. San Francisco">
            <select id="state" name="ShippingAddress.State" class="state">
              <option value="Alabama">AL</option>
              <option value="Alaska">AK</option>
              <option value="Arizona">AZ</option>
              <option value="Arkansas">AR</option>
              <option value="California">CA</option>
              <option value="Colorado">CO</option>
              <option value="Connecticut">CT</option>
              <option value="Delaware">DE</option>
              <option value="District Of Columbia">DC</option>
              <option value="Florida">FL</option>
              <option value="Georgia">GA</option>
              <option value="Hawaii">HI</option>
              <option value="Idaho">ID</option>
              <option value="Illinois">IL</option>
              <option value="Indiana">IN</option>
              <option value="Iowa">IA</option>
              <option value="Kansas">KS</option>
              <option value="Kentucky">KY</option>
              <option value="Louisiana">LA</option>
              <option value="Maine">ME</option>
              <option value="Maryland">MD</option>
              <option value="Massachusetts">MA</option>
              <option value="Michigan">MI</option>
              <option value="Minnesota">MN</option>
              <option value="Mississippi">MS</option>
              <option value="Missouri">MO</option>
              <option value="Montana">MT</option>
              <option value="Nebraska">NE</option>
              <option value="Nevada">NV</option>
              <option value="New Hampshire">NH</option>
              <option value="New Jersey">NJ</option>
              <option value="New Mexico">NM</option>
              <option value="New York">NY</option>
              <option value="North Carolina">NC</option>
              <option value="North Dakota">ND</option>
              <option value="Ohio">OH</option>
              <option value="Oklahoma">OK</option>
              <option value="Oregon">OR</option>
              <option value="Pennsylvania">PA</option>
              <option value="Rhode Island">RI</option>
              <option value="South Carolina">SC</option>
              <option value="South Dakota">SD</option>
              <option value="Tennessee">TN</option>
              <option value="Texas">TX</option>
              <option value="Utah">UT</option>
              <option value="Vermont">VT</option>
              <option value="Virginia">VA</option>
              <option value="Washington">WA</option>
              <option value="West Virginia">WV</option>
              <option value="Wisconsin">WI</option>
              <option value="Wyoming">WY</option>
            </select>
            <input id="postal_code" name="ShippingAddress.PostalCode" class="postal_code" type="text" value="Postal Code ex. 94107">
          </div>
        </div>
        <div class="narrow center perk">
        </div>
        <div class="narrow center item ar1">
          <div class="content-centered">
            <h2 class="underline">Skully AR-1 color &amp; size <span>(</span><span class="counter"></span><span class="total"></span></h2>
          </div>
          <div class="form">
          </div>
        </div>
        <div class="break-65"></div>
        <div class="narrow center item apparel">
          <div class="content-centered">
            <h2 class="underline">Skully Nation Apparel Color &amp; size <span>(</span><span class="counter"></span><span class="total"></span></h2>
          </div>
          <div class="form">
          </div>
        </div>
        <div class="break-65"></div>
        <div class="narrow center content-centered submit">
          <span>Please check to see if the above information is correct before submitting.</span>
          <input type="submit" value="SUBMIT">
        </div>
      </form>
    </div>
    <script type="text/javascript">
      $(document).ready(function(){
        function activateInput() {
          var el = $(this);
          if(!el.hasClass('active')) {
            el.addClass('active').val('').off('click');
            if(el.hasClass('password')) {
              el.attr('type', 'password');
            }
          }
        }

        $('input[type=text]').on('click', activateInput);

        // Total from perks
        var helmetTotal = 0;
        var gearTotal = 0;

        function countFunc(selector, total) {
          return function() {
            // Start looping over everything else
            var itemEl = $(selector);
            var counterEl = itemEl.find('.counter');

            var count = 0;
            itemEl.find('.quantity').each(function(){
              var val = parseInt($(this).val(), 10);
              if(isNaN(val)) {
                val = 0;
              }
              count += val;
            });
            if (count != total) {
              counterEl.addClass('bad');
            } else {
              counterEl.removeClass('bad');
            }
            counterEl.html(count);

            itemEl.find('.total').html('/'+total+')');
          }
        }

        function appendFunc(selector, variantT, countF) {
          var count = 0;
          var append = function() {
            var variantEl = $(variantT);
            if (count > 0) {
              var subButtonEl = $(subButtonT);
              subButtonEl.on('click', function(){
                variantEl.remove();
                count--;
                countF();
              });
              variantEl.append(subButtonEl);
            }

            variantEl.find('input[type=text]').on('click', activateInput);
            variantEl.find('input#quantity').payment('restrictNumeric').on('change keyup keypress', countF);
            variantEl.find('button.add').on('click', append);

            // Start here
            // variantEl.find('#color').attr

            $(selector).find('.form').append(variantEl);
            count++;
            return false;
          }
          return append;
        }

        var perkT = '\
<div class="instance">\
  <div class="content-centered">\
    <h2 class="underline">Perk: <span class="title"></span><span class="count"><span></h2>\
  </div>\
  <div class="content-centered description">\
    <p class="p1">Perk description here. Blah blah blah. Please follow format\
    of original perk cards with estimated shipping date down at the bottom.\
    Expand box to accomodate texts if necessary.</p>\
    <br/>\
    <p class="p2">Estimated Delivery: May 2015 (etc)</p>\
  </div>\
  <div class="break-65"></div>\
  </div>';

        function setText(el, selector, data) {
          el.find(selector).text(data);
        }

        function processPerks() {
          var perkMap = {};
          for(var i = 0; i < PreorderData.contributions.length; i++) {
            var contribution = PreorderData.contributions[i];
            var perk = perkMap[contribution.Perk.Id];
            if (!perk) {
              var perkEl = $(perkT);
              setText(perkEl, 'h2 span.title', contribution.Perk.Title);
              setText(perkEl, 'p.p1', contribution.Perk.Description);
              setText(perkEl, 'p.p2', contribution.Perk.EstimatedDelivery);
              perkMap[contribution.Perk.Id] = { el: perkEl, count: 1 };
              $('.perk').append(perkEl);
            } else {
              perk.count++;
              setText(perkEl, 'h2 span.count', ' [x' + perk.count + ']');
            }
            helmetTotal += parseInt(contribution.Perk.HelmetQuantity, 10);
            gearTotal += parseInt(contribution.Perk.GearQuantity, 10);
          }
        }

        processPerks();

        var subButtonT = '<button class="sub">-</button>';

        // AR 1 stuff, refactor
        var ar1VariantT = '\
<div class="row variant">\
  <select id="color" name="HelmetColor" class="color">\
    <option value="Matte Black">Matte Black</option>\
    <option value="Gloss White">Gloss White</option>\
  </select>\
  <select id="size" name="HelmetSize" class="size">\
    <option value="S">S</option>\
    <option value="M">M</option>\
    <option value="L">L</option>\
    <option value="XL">XL</option>\
    <option value="XXL">XXL</option>\
  </select>\
  <input id="quantity" name="" class="HelmetQuantity" type="text" maxlength="2" value="Qty.">\
  <button class="add">+</button>\
</div>';

        var countAr1 = countFunc('.item.ar1', helmetTotal);
        var appendAr1 = appendFunc('.item.ar1', ar1VariantT, countAr1);
        appendAr1();
        countAr1();

        var apparelVariantT = '\
<div class="row variant">\
  <select id="type" name="ShirtStyle" class="type">\
    <option value="Men\'s Shirt">Men\'s Shirt</option>\
    <option value="Women\'s Shirt">Women\'s Shirt</option>\
  </select>\
  <select id="color" name="ShirtColor" class="color">\
    <option value="Matte Black">Matte Black</option>\
    <option value="Shinny Black">Shiny Black</option>\
    <option value="Glossy Black">Glossy Black</option>\
    <option value="Dark Black">Dark Black</option>\
    <option value="Super Black">Super Black</option>\
  </select>\
  <select id="size" name="ShirtSize" class="size">\
    <option value="S">S</option>\
    <option value="M">M</option>\
    <option value="L">L</option>\
    <option value="XL">XL</option>\
  </select>\
  <input id="quantity" name="ShirtQuantity" class="quantity" type="text"  maxlength="2" value="Qty.">\
  <button class="add">+</button>\
</div>';

        var countApparel = countFunc('.item.apparel', gearTotal);
        var appendApparel = appendFunc('.item.apparel', apparelVariantT, countApparel);
        appendApparel();
        countApparel();

        function setValue(selector, data) {
          if (data != '') {
            $(selector).addClass('active').val(data);
          }
        }

        setValue('#email', PreorderData.user.Email);
        setValue('#first_name', PreorderData.user.FirstName);
        setValue('#last_name', PreorderData.user.LastName);
        setValue('#phone', PreorderData.user.Phone);
        setValue('#address1', PreorderData.user.ShippingAddress.Line1);
        setValue('#address2', PreorderData.user.ShippingAddress.Line2);
        setValue('#city', PreorderData.user.ShippingAddress.City);
        setValue('#state', PreorderData.user.ShippingAddress.State);
        setValue('#postal_code', PreorderData.user.ShippingAddress.PostalCode);

        function validateCount() {
          var ar1Count = parseInt($('.item.ar1 .counter').text(), 10);
          var apparelCount = parseInt($('.item.apparel .counter').text(), 10);

          var ret = true;
          if (ar1Count != helmetTotal) {
            $('.item.ar1 .quantity').addClass('fix');
            ret = false;
          }
          if (apparelCount != gearTotal) {
            $('.item.apparel .quantity').addClass('fix');
            ret = false;
          }
          return ret;
        }

        $('.submit input[type=submit]').on('click', function(){
          var ret = true;
          $('#skully').find('input[type=text], input[type=password]').each(function() {
            var el = $(this);
            // remove old validation things
            el.removeClass('fix');
            if(!(el.hasClass('active') || el.hasClass('optional'))) {
              el.addClass('fix');
              ret = false;
            }
          });
          if (ret) {
            $('#skully').find('input').each(function() {
              var el = $(this);
              if (!el.hasClass('active') && el.hasClass('optional')) {
                el.val('');
              }
            });
          }
          ret = validateCount() && ret;
          return ret;
        });

        var validator = new FormValidator("skully", [{
            name: 'email',
            rules: 'required|valid_email',
          }, {
            name: 'password',
            rules: 'required|min_length[6]',
          }, {
            name: 'password_confirm',
            display: 'password confirmation',
            rules: 'required|matches[password]',
          }, {
            name: 'first_name',
            display: 'first name',
            rules: 'required',
          }, {
            name: 'last_name',
            display: 'last name',
            rules: 'required',
          }, {
            name: 'phone',
            rules: 'required|callback_numeric_dash',
          }, {
            name: 'address1',
            display: 'address',
            rules: 'required',
          }, {
            name: 'city',
            rules: 'required',
          }, {
            name: 'postal_code',
            display: 'postal code',
            rules: 'required|alpha_dash',
          }],
          function(errors, event) {
            for(var i = 0; i < errors.length; i++) {
              $('#' + errors[i].id).addClass('fix');
            }
          });

          validator.registerCallback('numeric_dash', function(value) {
            return (new RegExp(/^[\d\-\s]+$/)).test(value);
          })
        });
    </script>
  </body>
</html>
