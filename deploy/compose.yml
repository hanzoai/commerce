# Hanzo Commerce - Docker Compose Stack
# Supports local development, staging, and production deployments
#
# Usage:
#   Development:  docker compose -f deploy/compose.yml up
#   Production:   docker compose -f deploy/compose.yml -f deploy/compose.production.yml up -d
#   Blue-Green:   docker compose -f deploy/compose.yml -f deploy/compose.blue-green.yml up -d
#
# Environment: Set COMPOSE_ENV=production for production mode

name: hanzo-commerce

services:
  # ===========================================================================
  # COMMERCE APPLICATION (Blue/Green Ready)
  # ===========================================================================

  commerce:
    build:
      context: ..
      dockerfile: deploy/Dockerfile
      args:
        VERSION: ${VERSION:-2.0.0}
        BUILD_TIME: ${BUILD_TIME:-}
        GIT_COMMIT: ${GIT_COMMIT:-}
    image: hanzoai/commerce:${VERSION:-latest}
    container_name: commerce-${DEPLOY_COLOR:-blue}
    restart: unless-stopped
    ports:
      - "${COMMERCE_PORT:-8001}:8001"
    environment:
      # Core configuration
      COMMERCE_DIR: /app/data
      COMMERCE_DEV: ${COMMERCE_DEV:-false}
      COMMERCE_SECRET: ${COMMERCE_SECRET:?Set COMMERCE_SECRET in .env}
      PORT: 8001
      ENV: ${ENV:-staging}

      # Redis caching
      REDIS_URL: redis://redis:6379

      # ClickHouse analytics
      CLICKHOUSE_URL: http://clickhouse:8123
      CLICKHOUSE_USER: ${CLICKHOUSE_USER:-default}
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD:-}
      COMMERCE_DATASTORE: clickhouse://${CLICKHOUSE_USER:-default}:${CLICKHOUSE_PASSWORD:-}@clickhouse:9000/commerce

      # External IAM (hanzo.id)
      IAM_URL: ${IAM_URL:-https://api.hanzo.id}
      IAM_API_KEY: ${IAM_API_KEY:-}

      # Payment processors
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-}
      STRIPE_PUBLISHABLE_KEY: ${STRIPE_PUBLISHABLE_KEY:-}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}

      # Email service
      SENDGRID_API_KEY: ${SENDGRID_API_KEY:-}
      MANDRILL_API_KEY: ${MANDRILL_API_KEY:-}

      # Deployment metadata
      DEPLOY_COLOR: ${DEPLOY_COLOR:-blue}
      DEPLOY_VERSION: ${VERSION:-2.0.0}
    volumes:
      - commerce_data:/app/data
      - commerce_logs:/app/logs
    depends_on:
      redis:
        condition: service_healthy
      clickhouse:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      start_period: 15s
      retries: 3
    networks:
      - commerce-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.commerce.rule=Host(`commerce.${DOMAIN:-localhost}`)"
      - "traefik.http.services.commerce.loadbalancer.server.port=8001"
      - "traefik.http.routers.commerce.entrypoints=websecure"
      - "traefik.http.routers.commerce.tls.certresolver=letsencrypt"

  # ===========================================================================
  # REDIS - Session & Cache Store
  # ===========================================================================

  redis:
    image: redis:7-alpine
    container_name: commerce-redis
    restart: unless-stopped
    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --requirepass ${REDIS_PASSWORD:-}
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - commerce-network

  # ===========================================================================
  # CLICKHOUSE - Analytics & Event Store
  # ===========================================================================

  clickhouse:
    image: clickhouse/clickhouse-server:24.3
    container_name: commerce-clickhouse
    restart: unless-stopped
    environment:
      CLICKHOUSE_DB: commerce
      CLICKHOUSE_USER: ${CLICKHOUSE_USER:-default}
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD:-}
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    ports:
      - "${CLICKHOUSE_HTTP_PORT:-8123}:8123"
      - "${CLICKHOUSE_NATIVE_PORT:-9000}:9000"
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - clickhouse_logs:/var/log/clickhouse-server
      - ./clickhouse/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD", "clickhouse-client", "--query", "SELECT 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - commerce-network
    ulimits:
      nofile:
        soft: 262144
        hard: 262144

  # ===========================================================================
  # NGINX - Reverse Proxy & Load Balancer (Optional, for Blue-Green)
  # ===========================================================================

  nginx:
    image: nginx:alpine
    container_name: commerce-nginx
    restart: unless-stopped
    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - nginx_logs:/var/log/nginx
    depends_on:
      - commerce
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - commerce-network
    profiles:
      - proxy
      - production

# ===========================================================================
# VOLUMES
# ===========================================================================

volumes:
  commerce_data:
    driver: local
  commerce_logs:
    driver: local
  redis_data:
    driver: local
  clickhouse_data:
    driver: local
  clickhouse_logs:
    driver: local
  nginx_logs:
    driver: local

# ===========================================================================
# NETWORKS
# ===========================================================================

networks:
  commerce-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
